# Система логирования P2P Telegram Bot

В проекте используется продвинутая система логирования на базе библиотеки Winston. Система предоставляет богатые возможности для отладки, мониторинга и анализа работы бота.

## Основные возможности

- **Уровни логирования**: error, warn, info, debug, verbose
- **Ротация логов**: автоматическое создание новых файлов логов с датой в имени
- **Максимальный размер лога**: автоматическое разделение на новые файлы при достижении заданного размера
- **Раздельные файлы для разных уровней**: отдельный файл для ошибок, общий лог для всех событий
- **Интеграция с Telegram**: возможность получать уведомления об ошибках в Telegram
- **Логирование HTTP-запросов**: автоматическое логирование запросов к API
- **Цветной вывод в консоль**: наглядное отображение логов в терминале
- **Автоматическая очистка**: удаление логов старше 30 дней
- **Расширенное логирование ошибок**: запись файла, функции, номера строки и колонки для точной диагностики

## Структура файлов логов

- **app-YYYY-MM-DD.log** - все логи за указанную дату
- **error-YYYY-MM-DD.log** - только ошибки за указанную дату

## Настройка логирования

Настройки логирования хранятся в `.env` файле:

```
NODE_ENV=development          # Режим работы (development/production)
TELEGRAM_BOT_TOKEN=token      # Токен бота для отправки логов
TELEGRAM_CHAT_ID=123456789    # ID чата для отправки логов
```

## Использование в коде

### Импорт функций логирования

```typescript
import { logInfo, logError, logDebug, logWarn } from '@/core/logs/logger';
```

### Логирование информационных сообщений

```typescript
logInfo('Пользователь зарегистрирован', { userId: 123, username: 'user' });
```

### Логирование ошибок

```typescript
try {
  // Ваш код
} catch (error) {
  logError(`Произошла ошибка: ${error.message}`, { 
    function: 'имяФункции', 
    stack: error.stack 
  });
}
```

### Автоматическое логирование ошибок с контекстом

```typescript
try {
  // Ваш код
} catch (error) {
  // Автоматически определяет файл, функцию и номер строки
  logErrorWithAutoDetails(`Произошла ошибка: ${error.message}`);
}
```

Результат в логе:
```
[17.04.2025, 00:01] [ERROR] [p2p-telegram-bot]: Произошла ошибка: Сообщение об ошибке
{
  "function": "createTransaction",
  "file": "wallet-service.ts",
  "line": 42,
  "column": 5
}
```

### Логирование отладочной информации

```typescript
logDebug('Детальная информация о транзакции', { txId, amount, sender, recipient });
```

### Логирование предупреждений

```typescript
logWarn('Предупреждение о нехватке средств', { walletId, balance, required });
```

## Логирование HTTP-запросов

В проекте настроено автоматическое логирование HTTP-запросов с использованием axios. Для этого созданы специальные утилиты:

```typescript
import { setupAxiosLogging, createLoggingAxios } from '@/utils/axios-logger';

// Настройка существующего экземпляра axios
const instance = setupAxiosLogging(axios, 'my-service');

// Создание нового экземпляра с логированием
const api = createLoggingAxios('https://api.example.com', 'example-api');
```

## Управление логами через Telegram

Для работы с логами в Telegram доступны следующие команды:

- `/getlogs` - получить последние файлы логов в личном чате с ботом (только для админов)
- `/getlogsgroup` - получить последние файлы логов в групповом чате (только для админов)
- `/getlogslist` - получить список всех доступных файлов логов (только для админов)
- `/getlog имя_файла` - получить конкретный файл лога по имени (только для админов)
- `/cleanuplogs [дней]` - удалить файлы логов старше указанного количества дней (по умолчанию 30 дней)

## Автоматическое управление логами

В системе настроено автоматическое управление логами:

1. **Ежедневная отправка** - каждый день в 9:00 по московскому времени отправляется отчет с последними логами в указанный чат
2. **Еженедельная очистка** - каждый понедельник в 3:00 по московскому времени удаляются логи старше 30 дней

Эти настройки можно изменить в файле `src/commands/get-logs.command.ts`. 